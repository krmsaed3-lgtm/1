<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Records</title>
  <style>
    :root{
      --page-bg:#05070b;
      --card:#0b2f3b;
      --muted:#7b8593;
      --text:#ffffff;
      --accent:#00e4c0;
      --border:#283341;
      --chip:#101622;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:var(--page-bg);
      color:var(--text);
    }
    .page{min-height:100vh;display:flex;flex-direction:column}
    .nav{
      height:46px;display:flex;align-items:center;justify-content:center;
      font-size:16px;font-weight:600;color:#ffffffd9;
    }
    .content{flex:1;overflow:auto;padding:10px 12px 90px}
    .card{
      border-radius:16px;
      background-image:linear-gradient(135deg,var(--card) 0%, #08252f 45%, #04151e 100%);
      border:1px solid rgba(0,0,0,.55);
      padding:14px;
      margin-bottom:10px;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .type{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:700;font-size:13px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    .meta{font-size:12px;color:var(--muted);margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
    .amt{font-size:14px;font-weight:700}
    .status{
      font-size:11px;
      padding:4px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#ffffffd9;
      white-space:nowrap;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .chip{
      background:var(--chip);
      border:1px solid rgba(255,255,255,.08);
      color:#ffffffd9;
      padding:7px 10px;border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{border-color:var(--accent);color:#000;background:linear-gradient(90deg,#00d1ff,#00e4c0)}
    .empty{
      padding:22px 14px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      color:var(--muted);
      text-align:center;
      margin-top:8px;
    }
    .hint{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
    @media (min-width: 480px){
      .page{max-width:480px;margin:0 auto}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="nav">Records</header>
    <main class="content">
      <div class="chips" id="filters">
        <div class="chip active" data-filter="all">All</div>
        <div class="chip" data-filter="deposit">Deposit</div>
        <div class="chip" data-filter="withdraw">Withdraw</div>
        <div class="chip" data-filter="swap">Swap</div>
      </div>

      <div id="list"></div>
      <div class="hint" id="hint"></div>
    </main>
  </div>

  <script>
  (function(){
    "use strict";

    var listEl = document.getElementById("list");
    var hintEl = document.getElementById("hint");
    var filter = "all";
    var txsCache = [];

    function esc(s){
      return String(s == null ? "" : s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function num(x){
      var n = Number(x);
      return isFinite(n) ? n : 0;
    }
    function fmt(n){
      // keep up to 8 decimals but trim zeros
      var s = (Math.round(n * 1e8) / 1e8).toString();
      return s;
    }
    function fmtDate(iso){
      try{
        var d = new Date(iso);
        if (isNaN(d.getTime())) return String(iso||"");
        return d.toLocaleString();
      }catch(e){ return String(iso||""); }
    }
    function normalizeTx(t){
      var type = String(t.type || t.tx_type || t.kind || "unknown").toLowerCase();
      var currency = String(t.currency || t.asset || t.token || "").toUpperCase();
      var amount = num(t.amount || t.tx_amount);
      var status = String(t.status || "SUCCESS").toUpperCase();
      var createdAt = t.createdAt || t.created_at || t.created_at_iso || new Date().toISOString();
      return {
        type:type,
        currency:currency,
        amount:amount,
        status:status,
        createdAt:createdAt,
        fee:num(t.fee || 0),
        net:num(t.net || amount),
        fromCurrency: (t.fromCurrency || t.from_currency || t.from || "").toString().toUpperCase(),
        toCurrency: (t.toCurrency || t.to_currency || t.to || "").toString().toUpperCase(),
        received: num(t.received || t.toAmount || t.to_amount || 0)
      };
    }

    function render(){
      var items = txsCache;
      if (filter !== "all") items = items.filter(function(t){ return t.type === filter; });

      if (!items.length){
        listEl.innerHTML = '<div class="empty">No records yet.</div>';
        return;
      }

      var html = items.map(function(t){
        var label = t.type.toUpperCase();
        var left = '<div class="type"><span class="dot"></span><span>' + esc(label) + '</span></div>';
        var amt = '';
        if (t.type === "swap"){
          var fromC = t.fromCurrency || t.currency;
          var toC = t.toCurrency || "";
          var recv = t.received;
          amt = '<div class="amt">' + esc(fmt(t.amount)) + ' ' + esc(fromC) + ' â†’ ' + esc(fmt(recv)) + ' ' + esc(toC) + '</div>';
        } else {
          amt = '<div class="amt">' + esc(fmt(t.amount)) + ' ' + esc(t.currency) + '</div>';
        }

        var status = '<div class="status">' + esc(t.status) + '</div>';
        var meta = [
          '<span>' + esc(fmtDate(t.createdAt)) + '</span>',
          (t.fee ? '<span>Fee: ' + esc(fmt(t.fee)) + '</span>' : ''),
          (t.net ? '<span>Net: ' + esc(fmt(t.net)) + '</span>' : '')
        ].filter(Boolean).join('');

        return '<section class="card">' +
                 '<div class="row">' +
                   '<div>' + left + '</div>' +
                   '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">' +
                      status +
                   '</div>' +
                 '</div>' +
                 '<div style="margin-top:10px">' + amt + '</div>' +
                 '<div class="meta">' + meta + '</div>' +
               '</section>';
      }).join("");

      listEl.innerHTML = html;
    }

    function setFilter(next){
      filter = next;
      document.querySelectorAll("#filters .chip").forEach(function(c){
        c.classList.toggle("active", c.getAttribute("data-filter") === filter);
      });
      render();
    }

    async function load(){
      hintEl.textContent = "";
      try{
        if (!window.DemoWallet || typeof DemoWallet.getTransactions !== "function"){
          hintEl.textContent = "wallet.js not loaded (DemoWallet.getTransactions missing).";
          txsCache = [];
          render();
          return;
        }
        var txs = await DemoWallet.getTransactions();
        if (!Array.isArray(txs)) txs = [];
        txsCache = txs.map(normalizeTx).sort(function(a,b){
          return (a.createdAt < b.createdAt) ? 1 : -1;
        });
        render();
      }catch(e){
        hintEl.textContent = "Failed to load records.";
      }
    }

    // Filters
    document.getElementById("filters").addEventListener("click", function(e){
      var chip = e.target.closest(".chip");
      if (!chip) return;
      setFilter(chip.getAttribute("data-filter"));
    });

    // Start
    load();
    setInterval(load, 1500);
  })();
  </script>

  <!-- Supabase configuration -->
  <script src="sb-config.js"></script>
  <!-- Auth helpers -->
  <script src="auth.js"></script>
  <!-- Wallet helpers (MUST provide DemoWallet.getTransactions) -->
  <script src="wallet.js"></script>
  <!-- Enforce login redirects -->
  <script src="common-nav.js"></script>
</body>
</html>
