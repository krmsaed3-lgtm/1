<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Site message</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#05070b;
      color:#fff;
    }
    .page{min-height:100vh;display:flex;flex-direction:column}
    .header{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      border-bottom:1px solid rgba(255,255,255,.08)
    }
    .header-title{font-size:16px;font-weight:600}
    .header-right{font-size:14px;color:#aaa}
    .content{padding:16px}
    .empty{text-align:center;margin-top:80px;color:#aaa}
    .list{display:none}
    .msg{
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
      background:rgba(255,255,255,.02)
    }
    .msg-title{font-weight:600;font-size:14px}
    .msg-body{font-size:13px;color:#ccc;margin-top:6px}
    .msg-time{font-size:11px;color:#777;margin-top:4px}
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:#ff3b30;display:inline-block;margin-right:6px
    }
  </style>
</head>

<body>
<div class="page">
  <div class="header">
    <div class="header-title">Site message</div>
    <div class="header-right" id="allRead">All read</div>
  </div>

  <div class="content">
    <div class="empty" id="emptyBox">
      No More Data<br/>Available
    </div>
    <div class="list" id="msgList"></div>
  </div>
</div>

<script src="sb-config.js"></script>
<script src="sb-user.js"></script>
<script src="auth.js"></script>
<script src="common-nav.js"></script>
<script>
/* ====== SITE MESSAGE JS ====== */

const listEl = document.getElementById('msgList');
const emptyEl = document.getElementById('emptyBox');
const allReadBtn = document.getElementById('allRead');

function getUserId(){
  return localStorage.getItem('currentUserId');
}

async function loadMessages(){
  const uid = getUserId();
  if(!uid) return;

  const res = await fetch(
    SB_CONFIG.url +
    /rest/v1/site_messages?user_id=eq.${uid}&order=created_at.desc,
    { headers: SB_CONFIG.headers() }
  );

  const data = await res.json();

  if(!data.length){
    emptyEl.style.display='block';
    listEl.style.display='none';
    return;
  }

  emptyEl.style.display='none';
  listEl.style.display='block';

  listEl.innerHTML = data.map(m => `
    <div class="msg">
      <div class="msg-title">
        ${m.is_read ? '' : '<span class="dot"></span>'}
        ${m.title}
      </div>
      <div class="msg-body">${m.body}</div>
      <div class="msg-time">${new Date(m.created_at).toLocaleString()}</div>
    </div>
  `).join('');
}

allReadBtn.onclick = async () => {
  const uid = getUserId();
  await fetch(
    SB_CONFIG.url +
    /rest/v1/site_messages?user_id=eq.${uid}&is_read=eq.false,
    {
      method:'PATCH',
      headers:{
        ...SB_CONFIG.headers(),
        'Content-Type':'application/json'
      },
      body: JSON.stringify({ is_read:true })
    }
  );
  loadMessages();
};

loadMessages();
</script>
</body>
</html>