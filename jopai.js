;(function () {
  'use strict';

  var input = document.querySelector('.chat-input');
  var sendBtn = document.querySelector('.send-btn');
  var log = document.getElementById('chatLog');

  function bubble(text, who) {
    var d = document.createElement('div');
    d.className = 'bubble ' + (who === 'me' ? 'me' : 'ai');
    d.textContent = text;
    log.appendChild(d);
    try { log.scrollTop = log.scrollHeight; } catch (e) {}
    try { window.scrollTo(0, document.body.scrollHeight); } catch (e) {}
  }

  function norm(s) {
    return String(s || '')
      .toLowerCase()
      .replace(/[^\u0600-\u06FFa-z0-9\s]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  // ููุงุนุฏ ุฑุฏูุฏ Jopai
  var KB = [
    {
      keys: ['ููู ุงุฑุจุญ', 'ููู ุงูุณุจ', 'ุงุฑุจุญ', 'ุงูุณุจ', 'ุฑุจุญ', 'profits', 'profit'],
      answer:
        "ุงูุฑุจุญ ูุนุชูุฏ ุนูู ุฑุตูุฏู ูุชูุนูู ุงูุฑุจุญ ุงููููู.\n" +
        "โข ูู 24 ุณุงุนุฉ ุจุชููุชู ูุชูุจุณู (ุงุณุชูุงู ุงูุฑุจุญ).\n" +
        "โข ุงูุฑุจุญ ููุญุณุจ ููุณุจุฉ ุญุณุจ ุงูุฑุตูุฏ.\n\n" +
        "ุจุฏู ููู ุนูู ุงูุฎุทูุงุช ุญุณุจ ุฑุตูุฏู ุงูุญุงููุ ุงูุชุจูู: ูู ุฑุตูุฏูุ",
      follow: ["ูู ุฑุตูุฏู ุงูุญุงููุ", "ุจุชุณุชูู ุงูุฑุจุญ ูุฑุฉ ูู 24 ุณุงุนุฉุ"]
    },
    {
      keys: ['ููุฉ ุงูุญูุณุจุฉ', 'ุญูุณุจุฉ', 'computing', 'power'],
      answer:
        "ููุฉ ุงูุญูุณุจุฉ ุจุชุฎููู ุชุฑุจุญู ุจุดูู ุฃุณูู ูุฃู ุงูุนุงุฆุฏ ูุฑุชุจุท ุจุฑุตูุฏู/ูุณุชูุงู.\n" +
        "ูู ูุง ุฒุงุฏ ุงูุฑุตูุฏ ุฃู ุงููุณุชููุ ุฒุงุฏ ุงูุนุงุฆุฏ ุงููููู.\n\n" +
        "ุจุฏู ุดุฑุญ ุณุฑูุน: ูู ูุฏูู ุฑุจุญ ูููู ููุง ูุถุงุนูุฉ ุงูุฑุตูุฏุ",
      follow: ["ุจุฏู ุฑุจุญ ูููู ููุง ูุถุงุนูุฉุ", "ุดู ุฑุตูุฏู ุงูุขูุ"]
    },
    {
      keys: ['ูู ุฑุจุญ ุงูููู', 'ุฑุจุญ ุงูููู', 'ุงูููู ูู', 'daily', 'today'],
      answer:
        "ุฑุจุญ ุงูููู ููุญุณุจ ุญุณุจ ุฑุตูุฏู ุงูุญุงูู ููุณุจุฉ ุงูุฑุจุญ ุงูููููุฉ.\n" +
        "ุฅุฐุง ุนุทูุชูู ุฑูู ุฑุตูุฏูุ ุจุญุณุจูู ูุซุงู ูุงุถุญ.\n\n" +
        "ุงูุชุจูู: ุฑุตูุฏู ูู (USDT)ุ",
      follow: ["ูู ุฑุตูุฏู ุจุงูู USDTุ", "ูู ุงูุฑุจุญ ูุณุจุฉ ุซุงุจุชุฉ ููุง ุจุชุชุบูุฑุ"]
    },
    {
      keys: ['ุถุงุนู', 'ูุถุงุนูุฉ', 'ุงูุจุฑ', 'ุฒูุงุฏุฉ ุงูุฑุจุญ', 'ุงุฑุจุงุญู', 'ุถุงุนู ุงุฑุจุงุญู'],
      answer:
        "ูู ุทุฑู ูุฒูุงุฏุฉ ุฃุฑุจุงุญู:\n" +
        "1) ุฏุนูุฉ ุงูุฃุตุฏูุงุก (Referral) โ ูู ุฏุนูุฉ ูุงุฌุญุฉ ุจุชุฒูุฏ ููุงูุขุชู.\n" +
        "2) ุฑูุน ุงููุณุชูู/ุงูุฎุทุฉ ุฅุฐุง ูุชุงุญ.\n" +
        "3) ุงูุงูุชุฒุงู ุจุงูุงุณุชูุงู ุงููููู ุจุฏูู ุงููุทุงุน.\n\n" +
        "ุจุฏู ุฃุดุฑุญ ูู ูุธุงู ุฏุนูุฉ ุงูุฃุตุฏูุงุก ูููู ุชุณุชููุฏ ูููุ",
      follow: ["ุจุฏู ุดุฑุญ ุฏุนูุฉ ุงูุฃุตุฏูุงุกุ", "ูู ุนูุฏู ููุฏ ุฏุนูุฉุ"]
    },
    {
      keys: ['ุฏุนูุฉ', 'ุฏุนูู', 'ุงุตุฏูุงุก', 'reffer', 'referral', 'invite'],
      answer:
        "ุนู ุทุฑูู ุฏุนูุฉ ุงูุฃุตุฏูุงุก ุจุชูุฏุฑู ุชุถุงุนูู ุฃุฑุจุงุญู:\n" +
        "โข ุดุงุฑูู ุฑุงุจุท/ููุฏ ุงูุฏุนูุฉ.\n" +
        "โข ููุง ูุณุฌู ุตุฏููู ููุตูุฑ ูุนูุงูุ ุจุชุงุฎุฏู ููุงูุฃุฉ.\n\n" +
        "ุจุฏู ุชูุนููู ุฑุงุจุท ุงูุฏุนูุฉ ุนูุฏูุ ูููููู ุฅุฐุง ุนูุฏู (Invite Code) ุฃู ูุง.",
      follow: ["ุนูุฏู Invite Codeุ", "ุจุฏู ุฑุณุงูุฉ ุฌุงูุฒุฉ ุชุจุนุชููุง ูุฃุตุฏูุงุฆูุ"]
    },
    {
      keys: ['ุณุญุจ', 'withdraw', 'ุงุณุญุจ', 'withdrawal'],
      answer:
        "ุจุงูุณุญุจ ุนุงุฏุฉ ูู ุดุฑูุท ูุงุฒู ุชูุชุจูู ุฅููุง:\n" +
        "โข ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ.\n" +
        "โข ููุช ุงููุนุงูุฌุฉ.\n" +
        "โข ุฑุณูู ุงูุดุจูุฉ.\n\n" +
        "ูููููู: ุดู ุงูุนููุฉ ุงููู ุจุฏู ุชุณุญุจููุง (USDT ููุง ุบูุฑูุง)ุ",
      follow: ["USDT ููุง ุนููุฉ ุซุงููุฉุ", "ูุฏูุด ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ ุนูุฏูุ"]
    },
    {
      keys: ['ุงูุฏุงุน', 'ุฅูุฏุงุน', 'deposit'],
      answer:
        "ููุฅูุฏุงุน: ุชุฃูุฏู ูู ุงุฎุชูุงุฑ ุงูุดุจูุฉ ุงูุตุญูุญุฉ ูุจู ูุง ุชุจุนุชู.\n" +
        "ุจุงูุนุงุฏุฉ USDT ูููู ูููู ุนูู (TRC20 / ERC20 / BSC)ุ ููุงุฒู ุชุทุงุจู ุงูุดุจูุฉ.\n\n" +
        "ุดู ุงูุดุจูุฉ ุงููู ุนู ุชุณุชุฎุฏูููุงุ",
      follow: ["TRC20 ููุง BSC ููุง ERC20ุ", "ุจุฏู ุฎุทูุงุช ุงูุฅูุฏุงุนุ"]
    },
    {
      keys: ['ูุฑุญุจุง', 'ููุง', 'ูุงู', 'hello', 'hi', 'ุงููุง'],
      answer:
        "ุฃููุงู ูููู ๐ค ุฃูุง Jopai.\n" +
        "ุงุณุฃูููู ูุซูุงู:\n" +
        "โข ููู ุฃุฑุจุญุ\n" +
        "โข ูู ุฑุจุญ ุงูููู ุญุณุจ ุฑุตูุฏูุ\n" +
        "โข ููู ุฃุถุงุนู ุฃุฑุจุงุญูุ\n" +
        "โข ููู ุฃุณุชููุฏ ูู ุฏุนูุฉ ุงูุฃุตุฏูุงุกุ"
    }
  ];

  function bestMatch(q) {
    var s = norm(q);
    if (!s) return null;

    var best = null;
    var bestScore = 0;

    for (var i = 0; i < KB.length; i++) {
      var item = KB[i];
      var score = 0;
      for (var k = 0; k < item.keys.length; k++) {
        var key = norm(item.keys[k]);
        if (!key) continue;
        // ุชุทุงุจู ุจุณูุท: ุฅุฐุง ุงูุฌููุฉ ุชุญุชูู ุงููููุฉ
        if (s.indexOf(key) !== -1) score += 2;
        // ุชุทุงุจู ุฌุฒุฆู: ุฅุฐุง ูููุฉ ูู ุงูููุชุงุญ ููุฌูุฏุฉ
        var parts = key.split(' ');
        for (var p = 0; p < parts.length; p++) {
          if (parts[p].length >= 3 && s.indexOf(parts[p]) !== -1) score += 1;
        }
      }
      if (score > bestScore) {
        bestScore = score;
        best = item;
      }
    }

    return bestScore > 0 ? best : null;
  }

  function fallbackReply(q) {
    return (
      "ูููุช ุนููู ๐\n" +
      "ุจุณ ุฎุจุฑููู ูุตุฏู ุฃู ูุงุญุฏุ\n" +
      "1) ููู ุชุฑุจุญูุ\n" +
      "2) ูู ุฑุจุญ ุงูููู ุญุณุจ ุฑุตูุฏูุ\n" +
      "3) ููู ุชุถุงุนูู ุฃุฑุจุงุญูุ\n" +
      "4) ุฏุนูุฉ ุงูุฃุตุฏูุงุก\n\n" +
      "ุงูุชุจู ุฑูู ุงูุฎูุงุฑ ุฃู ุงุณุฃูู ุจุณุคุงู ุฃูุตุฑ."
    );
  }

  function onSend() {
    var text = (input && input.value ? String(input.value) : '').trim();
    if (!text) return;

    input.value = '';
    bubble(text, 'me');

    var hit = bestMatch(text);
    if (!hit) {
      bubble(fallbackReply(text), 'ai');
      return;
    }

    bubble(hit.answer, 'ai');

    // ุฃุณุฆูุฉ ูุชุงุจุนุฉ (ุงุฎุชูุงุฑู)
    if (hit.follow && hit.follow.length) {
      var f = hit.follow.slice(0, 2).map(function (x) { return "โข " + x; }).join("\n");
      bubble("ูุจู ูุง ุฃูููุ ุฌุงูุจููู:\n" + f, 'ai');
    }
  }

  if (sendBtn) sendBtn.addEventListener('click', onSend);
  if (input) {
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') onSend();
    });
  }
})();
